<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Legacy Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@metamask/detect-provider"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-xl font-bold">Digital Legacy Manager</h1>
                    </div>
                </div>
                <div class="flex items-center">
                    <button id="navConnectWallet" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Connect Wallet
                    </button>
                    <button id="navLogout" class="hidden ml-4 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Login Section -->
        <div id="login" class="text-center py-12">
            <h2 class="text-2xl font-bold mb-4">Choose Your Login Method</h2>
            <p class="text-gray-600 mb-8">Secure your digital legacy with blockchain technology</p>
            
            <div class="max-w-md mx-auto">
                <!-- Username Field (shared) -->
                <div class="mb-4">
                    <label for="login-username" class="block text-sm font-medium text-gray-700 text-left">Username</label>
                    <input type="text" id="login-username" name="username" placeholder="Enter username or leave blank to auto-generate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <!-- MetaMask Login -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">Login with MetaMask</h3>
                    <button id="loginConnectWallet" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="w-6 h-6 mr-2">
                        Connect with MetaMask
                    </button>
                </div>

                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-gray-100 text-gray-500">Or</span>
                    </div>
                </div>

                <!-- Email Login -->
                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-4">Login with Email</h3>
                    <form id="emailLoginForm" class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 text-left">Email address</label>
                            <input type="email" id="email" name="email" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <button type="submit"
                            class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                            Send OTP
                        </button>
                    </form>

                    <!-- OTP Verification Form (Hidden by default) -->
                    <form id="otpVerificationForm" class="space-y-4 mt-4 hidden">
                        <div>
                            <label for="otp" class="block text-sm font-medium text-gray-700 text-left">Enter OTP</label>
                            <input type="text" id="otp" name="otp" required maxlength="6" pattern="[0-9]*"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                placeholder="Enter 6-digit OTP">
                        </div>
                        <button type="submit"
                            class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                            Verify OTP
                        </button>
                        <div class="text-sm text-center">
                            <button type="button" id="resendOtp" class="text-blue-600 hover:text-blue-500">
                                Resend OTP
                            </button>
                        </div>
                    </form>

                    <p class="mt-4 text-sm text-gray-600">
                        Don't have an account? 
                        <a href="#" id="showSignup" class="font-medium text-blue-600 hover:text-blue-500">Sign up</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Signup Section (Hidden by default) -->
        <div id="signup" class="hidden text-center py-12">
            <h2 class="text-2xl font-bold mb-4">Create Your Account</h2>
            <p class="text-gray-600 mb-8">Join us to start preserving your digital legacy</p>
            
            <div class="max-w-md mx-auto">
                <form id="signupForm" class="space-y-4">
                    <div>
                        <label for="signup-username" class="block text-sm font-medium text-gray-700 text-left">Username</label>
                        <input type="text" id="signup-username" name="username" placeholder="Enter username or leave blank to auto-generate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 text-left">Email address</label>
                        <input type="email" id="signup-email" name="email" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="signup-fullname" class="block text-sm font-medium text-gray-700 text-left">Full Name</label>
                        <input type="text" id="signup-fullname" name="full_name" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="signup-phone" class="block text-sm font-medium text-gray-700 text-left">Phone Number</label>
                        <input type="tel" id="signup-phone" name="phone_number" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="signup-dob" class="block text-sm font-medium text-gray-700 text-left">Date of Birth</label>
                        <input type="date" id="signup-dob" name="date_of_birth" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="signup-address" class="block text-sm font-medium text-gray-700 text-left">Address</label>
                        <input type="text" id="signup-address" name="address" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="signup-bio" class="block text-sm font-medium text-gray-700 text-left">Bio</label>
                        <textarea id="signup-bio" name="bio" rows="3" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit"
                        class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                        Send OTP
                    </button>
                </form>

                <!-- Signup OTP Verification Form (Hidden by default) -->
                <form id="signupOtpVerificationForm" class="space-y-4 mt-4 hidden">
                    <div>
                        <label for="signup-otp" class="block text-sm font-medium text-gray-700 text-left">Enter OTP</label>
                        <input type="text" id="signup-otp" name="otp" required maxlength="6" pattern="[0-9]*"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                            placeholder="Enter 6-digit OTP">
                    </div>
                    <button type="submit"
                        class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                        Verify OTP
                    </button>
                    <div class="text-sm text-center">
                        <button type="button" id="resendSignupOtp" class="text-blue-600 hover:text-blue-500">
                            Resend OTP
                        </button>
                    </div>
                </form>

                <p class="mt-4 text-sm text-gray-600">
                    Already have an account? 
                    <a href="#" id="showLogin" class="font-medium text-blue-600 hover:text-blue-500">Sign in</a>
                </p>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="hidden">
            <!-- Profile Section -->
            <div class="bg-white overflow-hidden shadow rounded-lg mb-6">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Profile</h3>
                    <div id="profileContent" class="space-y-4">
                        <!-- Profile content will be loaded here -->
                    </div>
                    <div id="connectWalletSection" class="mt-4"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Digital Assets Card -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg font-medium text-gray-900">Digital Assets</h3>
                        <div class="mt-4">
                            <form id="uploadForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Upload File</label>
                                    <input type="file" id="assetFile" class="mt-1 block w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Title</label>
                                    <input type="text" id="assetTitle" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Upload</button>
                            </form>
                            
                            <!-- Asset List -->
                            <div class="mt-6">
                                <h4 class="text-md font-medium text-gray-900 mb-2">Your Assets</h4>
                                <div id="assetList" class="space-y-2">
                                    <!-- Assets will be listed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Access Rules Card -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg font-medium text-gray-900">Access Rules</h3>
                        <div class="mt-4">
                            <form id="accessRuleForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Beneficiary Address</label>
                                    <input type="text" id="beneficiaryAddress" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Trigger Date</label>
                                    <input type="datetime-local" id="triggerDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Create Rule</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Scheduled Messages Card -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg font-medium text-gray-900">Scheduled Messages</h3>
                        <div class="mt-4">
                            <form id="messageForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Recipient Address</label>
                                    <input type="text" id="recipientAddress" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Message</label>
                                    <textarea id="messageContent" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Delivery Date</label>
                                    <input type="datetime-local" id="deliveryDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Schedule</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- User Guide Section (moved here, hidden by default) -->
            <div id="userGuide" class="bg-white shadow-lg rounded-lg p-8 mb-8 mt-8 hidden">
                <h2 class="text-2xl font-bold mb-6">How to Use Digital Legacy Manager</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Step 1 -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <div class="text-blue-500 text-2xl mb-4">1</div>
                        <h3 class="font-semibold mb-2">Connect Your Wallet</h3>
                        <p class="text-gray-600">Click the "Connect Wallet" button to link your MetaMask wallet. This is required to manage your digital legacy securely.</p>
                    </div>
                    <!-- Step 2 -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <div class="text-blue-500 text-2xl mb-4">2</div>
                        <h3 class="font-semibold mb-2">Upload Digital Assets</h3>
                        <p class="text-gray-600">Use the Digital Assets card to upload important files, documents, or media. Add a title and select the file you want to preserve.</p>
                    </div>
                    <!-- Step 3 -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <div class="text-blue-500 text-2xl mb-4">3</div>
                        <h3 class="font-semibold mb-2">Set Access Rules</h3>
                        <p class="text-gray-600">Specify who can access your assets and when. Add beneficiary addresses and set trigger dates for access.</p>
                    </div>
                </div>
                <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold mb-2">Important Tips:</h3>
                    <ul class="list-disc list-inside text-gray-600 space-y-2">
                        <li>Always verify beneficiary addresses before setting access rules</li>
                        <li>Keep your MetaMask wallet secure and backup your seed phrase</li>
                        <li>Regularly review and update your access rules as needed</li>
                        <li>Use descriptive titles for your assets to make them easily identifiable</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <script>
        let web3;
        let userAccount;
        let currentEmail = '';
        let currentUsername = '';
        let isMetaMaskProcessing = false;

        // Utility to generate user ID
        function generateUserId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // On page load, restore user identifier if present and attach event listeners ONCE
        document.addEventListener('DOMContentLoaded', function() {
            const savedUser = localStorage.getItem('userIdentifier');
            if (savedUser) {
                currentUsername = savedUser;
                userAccount = savedUser;
            }
            // Attach MetaMask event listeners ONCE
            document.getElementById('navConnectWallet').addEventListener('click', connectWallet);
            document.getElementById('loginConnectWallet').addEventListener('click', connectWallet);

            // Email login handler
            document.getElementById('emailLoginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                currentEmail = email;
                
                try {
                    const response = await fetch('/api/v1/auth/request-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    
                    if (response.ok) {
                        document.getElementById('emailLoginForm').classList.add('hidden');
                        document.getElementById('otpVerificationForm').classList.remove('hidden');
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'Failed to send OTP');
                    }
                } catch (error) {
                    alert('Failed to send OTP. Please try again.');
                }
            });

            // OTP verification handler
            document.getElementById('otpVerificationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const otp = document.getElementById('otp').value;
                
                try {
                    const response = await fetch('/api/v1/auth/verify-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email: currentEmail, 
                            otp 
                        })
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        console.log('Login successful, user data:', userData);
                        showDashboard();
                        document.getElementById('navConnectWallet').textContent = `Connected: ${currentEmail.slice(0,6)}...${currentEmail.slice(-4)}`;
                        document.getElementById('navConnectWallet').classList.add('hidden');
                        document.getElementById('navLogout').classList.remove('hidden');
                        localStorage.setItem('userIdentifier', userData.user.username);
                        localStorage.setItem('userId', userData.user.id);
                        console.log('Stored userId:', userData.user.id);
                        loadAssets();
                        loadProfile();
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'Invalid OTP');
                    }
                } catch (error) {
                    alert('Failed to verify OTP. Please try again.');
                }
            });

            // Resend OTP handler
            document.getElementById('resendOtp').addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/v1/auth/send-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email: currentEmail })
                    });
                    
                    if (response.ok) {
                        alert('New OTP sent to your email!');
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'Failed to resend OTP');
                    }
                } catch (error) {
                    console.error('Resend OTP error:', error);
                    alert('Failed to resend OTP. Please try again.');
                }
            });

            // Signup handler
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('signup-username').value.trim() || generateUserId();
                const email = document.getElementById('signup-email').value;
                const fullName = document.getElementById('signup-fullname').value;
                const phoneNumber = document.getElementById('signup-phone').value;
                const dateOfBirth = document.getElementById('signup-dob').value;
                const address = document.getElementById('signup-address').value;
                const bio = document.getElementById('signup-bio').value;
                
                currentUsername = username;
                userAccount = username;
                currentEmail = email;
                localStorage.setItem('userIdentifier', username);
                
                try {
                    const response = await fetch('/api/v1/auth/request-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email,
                            username,
                            full_name: fullName,
                            phone_number: phoneNumber,
                            date_of_birth: dateOfBirth,
                            address,
                            bio
                        })
                    });
                    
                    if (response.ok) {
                        document.getElementById('signupForm').classList.add('hidden');
                        document.getElementById('otpVerificationForm').classList.remove('hidden');
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'Failed to send OTP');
                    }
                } catch (error) {
                    alert('Failed to send OTP. Please try again.');
                }
            });

            // OTP verification handler
            document.getElementById('otpVerificationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const otp = document.getElementById('otp').value;
                const username = document.getElementById('signup-username').value.trim() || generateUserId();
                const fullName = document.getElementById('signup-fullname').value;
                const phoneNumber = document.getElementById('signup-phone').value;
                const dateOfBirth = document.getElementById('signup-dob').value;
                const address = document.getElementById('signup-address').value;
                const bio = document.getElementById('signup-bio').value;
                
                try {
                    const response = await fetch('/api/v1/auth/verify-signup-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: currentEmail,
                            otp,
                            username,
                            full_name: fullName,
                            phone_number: phoneNumber,
                            date_of_birth: dateOfBirth,
                            address,
                            bio
                        })
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        console.log('Signup successful, user data:', userData);
                        showDashboard();
                        document.getElementById('navConnectWallet').textContent = `Connected: ${currentEmail.slice(0,6)}...${currentEmail.slice(-4)}`;
                        document.getElementById('navConnectWallet').classList.add('hidden');
                        document.getElementById('navLogout').classList.remove('hidden');
                        localStorage.setItem('userIdentifier', username);
                        localStorage.setItem('userId', userData.user.id);
                        console.log('Stored userId:', userData.user.id);
                        loadAssets();
                        loadProfile();
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'Invalid OTP');
                    }
                } catch (error) {
                    alert('Failed to verify OTP. Please try again.');
                }
            });

            // Toggle between login and signup views
            document.getElementById('showSignup').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('login').classList.add('hidden');
                document.getElementById('signup').classList.remove('hidden');
            });

            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('signup').classList.add('hidden');
                document.getElementById('login').classList.remove('hidden');
            });

            // Handle file upload
            document.getElementById('uploadForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('assetFile');
                const titleInput = document.getElementById('assetTitle');
                
                if (!fileInput.files.length) {
                    alert('Please select a file to upload');
                    return;
                }
                
                const userId = localStorage.getItem('userId');
                console.log('Current userId from localStorage:', userId); // Debug log
                console.log('All localStorage items:', Object.keys(localStorage).map(key => `${key}: ${localStorage.getItem(key)}`)); // Debug log
                
                if (!userId) {
                    alert('Please log in first');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('title', titleInput.value.trim() || fileInput.files[0].name);
                formData.append('user_id', userId);
                
                // Debug log the form data
                for (let pair of formData.entries()) {
                    console.log(pair[0] + ': ' + pair[1]);
                }
                
                try {
                    const response = await fetch('/api/v1/assets/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const responseData = await response.json();
                    console.log('Server response:', responseData); // Debug log
                    
                    if (response.ok) {
                        alert('Asset uploaded successfully!');
                        fileInput.value = '';
                        titleInput.value = '';
                        loadAssets();  // Reload the assets list
                    } else {
                        console.error('Upload error response:', responseData); // Debug log
                        throw new Error(responseData.detail || 'Failed to upload asset');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert(`Failed to upload asset: ${error.message}`);
                }
            });

            // Handle access rule creation
            document.getElementById('accessRuleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    beneficiary_address: document.getElementById('beneficiaryAddress').value,
                    trigger_date: document.getElementById('triggerDate').value,
                    user_id: localStorage.getItem('userIdentifier') || userAccount,
                    access_type: 'view',
                    trigger_condition: 'date'
                };

                try {
                    const response = await fetch('/api/v1/access-rules/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    if (response.ok) {
                        alert('Access rule created successfully!');
                    }
                } catch (error) {
                    console.error(error);
                    alert('Failed to create access rule');
                }
            });

            // Handle scheduled message creation
            document.getElementById('messageForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const recipientAddress = document.getElementById('recipientAddress').value.trim();
                const messageContent = document.getElementById('messageContent').value.trim();
                const deliveryDate = document.getElementById('deliveryDate').value;
                
                // Validate inputs
                if (!recipientAddress) {
                    alert('Please enter a recipient address');
                    return;
                }
                
                if (!messageContent) {
                    alert('Please enter a message');
                    return;
                }
                
                if (!deliveryDate) {
                    alert('Please select a delivery date');
                    return;
                }
                
                // Validate Ethereum address format
                if (!web3.utils.isAddress(recipientAddress)) {
                    alert('Please enter a valid Ethereum address');
                    return;
                }
                
                // Validate delivery date is in the future
                const selectedDate = new Date(deliveryDate);
                if (selectedDate <= new Date()) {
                    alert('Delivery date must be in the future');
                    return;
                }
                
                const data = {
                    recipient_address: recipientAddress,
                    message_content: messageContent,
                    delivery_date: selectedDate.toISOString(),
                    user_id: localStorage.getItem('userIdentifier') || userAccount
                };

                try {
                    console.log('Sending scheduled message request:', data);
                    const response = await fetch('/api/v1/messages/schedule', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Message scheduled successfully:', result);
                        alert('Message scheduled successfully!');
                        document.getElementById('messageForm').reset();
                    } else {
                        const error = await response.json();
                        console.error('Failed to schedule message:', error);
                        alert(`Failed to schedule message: ${error.detail || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Message scheduling error:', error);
                    alert('Failed to schedule message. Please try again.');
                }
            });

            // Add logout function
            document.getElementById('navLogout').addEventListener('click', logout);
        });

        function showLogin() {
            document.getElementById('signup').classList.add('hidden');
            document.getElementById('login').classList.remove('hidden');
        }

        function showDashboard() {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('signup').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('userGuide').classList.remove('hidden');
            loadProfile();
            loadAssets();
        }

        // MetaMask login handler
        async function connectWallet(event) {
            if (isMetaMaskProcessing) {
                console.log('MetaMask login already processing, ignoring click.');
                return;
            }
            isMetaMaskProcessing = true;
            document.getElementById('loginConnectWallet').disabled = true;
            document.getElementById('navConnectWallet').disabled = true;
            if (document.getElementById('dashboardConnectWallet')) {
                document.getElementById('dashboardConnectWallet').disabled = true;
            }
            console.log('MetaMask login started.');
            try {
                const provider = await window.ethereum;
                if (!provider) {
                    throw new Error('Please install MetaMask!');
                }
                web3 = new Web3(provider);
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                const walletAddress = accounts[0];
                const message = `Login to Digital Legacy at ${new Date().toISOString().split('T')[0]}`;
                const signature = await web3.eth.personal.sign(message, walletAddress);
                // Determine if user is logged in (has userId in localStorage)
                const isLoggedIn = !!localStorage.getItem('userId');
                // Prepare payload: only include email if user is logged in (dashboard connect)
                const payload = {
                    wallet_address: walletAddress,
                    signature: signature
                };
                if (isLoggedIn && currentEmail) payload.email = currentEmail;
                const response = await fetch('/api/v1/auth/connect-wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    const userData = await response.json();
                    localStorage.setItem('userIdentifier', userData.user.username || userData.user.wallet_address);
                    localStorage.setItem('userId', userData.user.id);
                    localStorage.setItem('accessToken', userData.access_token);
                    showDashboard();
                    loadProfile(); // Ensure UI updates after wallet connect
                    document.getElementById('navConnectWallet').textContent = `Connected: ${walletAddress.slice(0,6)}...${walletAddress.slice(-4)}`;
                    document.getElementById('navConnectWallet').classList.add('hidden');
                    document.getElementById('navLogout').classList.remove('hidden');
                    loadAssets();
                    // If user doesn't have an email, show email collection form
                    if (!userData.user.email) {
                        showEmailCollectionForm();
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to connect wallet');
                }
            } catch (error) {
                if (error.message.includes('User denied')) {
                    alert('Please approve the connection request in MetaMask');
                } else if (error.message.includes('MetaMask')) {
                    alert('Please install MetaMask!');
                } else if (error.message.includes('eth_requestAccounts')) {
                    alert('MetaMask is already processing a request. Please wait.');
                } else {
                    alert(`Connection failed: ${error.message}`);
                }
                console.error('MetaMask login error:', error);
            } finally {
                isMetaMaskProcessing = false;
                document.getElementById('loginConnectWallet').disabled = false;
                document.getElementById('navConnectWallet').disabled = false;
                if (document.getElementById('dashboardConnectWallet')) {
                    document.getElementById('dashboardConnectWallet').disabled = false;
                }
                console.log('MetaMask login finished.');
            }
        }

        // Add email collection form
        function showEmailCollectionForm() {
            const dashboard = document.getElementById('dashboard');
            const emailForm = document.createElement('div');
            emailForm.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full';
            emailForm.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Add Email Address</h3>
                        <div class="mt-2 px-7 py-3">
                            <p class="text-sm text-gray-500">
                                Please add your email address to enable email-based login and notifications.
                            </p>
                            <form id="emailCollectionForm" class="mt-4">
                                <input type="email" id="walletEmail" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Enter your email address">
                                <button type="submit"
                                    class="mt-4 w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                    Save Email
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            dashboard.appendChild(emailForm);
            
            // Handle email collection form submission
            document.getElementById('emailCollectionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('walletEmail').value;
                
                try {
                    const response = await fetch('/api/v1/auth/request-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    
                    if (response.ok) {
                        emailForm.remove();
                        showOtpVerificationForm(email);
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'Failed to send OTP');
                    }
                } catch (error) {
                    alert('Failed to send OTP. Please try again.');
                }
            });
        }

        // Show OTP verification form
        function showOtpVerificationForm(email) {
            const dashboard = document.getElementById('dashboard');
            const otpForm = document.createElement('div');
            otpForm.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full';
            otpForm.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Verify Email</h3>
                        <div class="mt-2 px-7 py-3">
                            <p class="text-sm text-gray-500">
                                Please enter the OTP sent to your email address.
                            </p>
                            <form id="walletOtpVerificationForm" class="mt-4">
                                <input type="text" id="walletOtp" required maxlength="6" pattern="[0-9]*"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Enter 6-digit OTP">
                                <button type="submit"
                                    class="mt-4 w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                    Verify OTP
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            dashboard.appendChild(otpForm);
            
            // Handle OTP verification form submission
            document.getElementById('walletOtpVerificationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const otp = document.getElementById('walletOtp').value;
                
                try {
                    const response = await fetch('/api/v1/auth/verify-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, otp })
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        localStorage.setItem('userIdentifier', userData.user.username || userData.user.wallet_address);
                        localStorage.setItem('userId', userData.user.id);
                        localStorage.setItem('accessToken', userData.access_token);
                        otpForm.remove();
                        loadProfile();
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'Invalid OTP');
                    }
                } catch (error) {
                    alert('Failed to verify OTP. Please try again.');
                }
            });
        }

        // Update loadAssets to use the stored user ID
        async function loadAssets() {
            try {
                const userId = localStorage.getItem('userId');
                console.log('Loading assets for userId:', userId); // Debug log
                
                if (!userId) {
                    console.error('No user ID found');
                    return;
                }
                
                const response = await fetch(`/api/v1/assets/list?user_id=${userId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const assets = await response.json();
                    console.log('Loaded assets:', assets); // Debug log
                    
                    const assetList = document.getElementById('assetList');
                    assetList.innerHTML = '';
                    assets.forEach(asset => {
                        const assetElement = document.createElement('div');
                        assetElement.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                        assetElement.innerHTML = `
                            <span>${asset.title}</span>
                            <a href="/api/v1/assets/${asset.id}/download?user_id=${userId}" class="text-blue-500 hover:text-blue-700" download>Download</a>
                        `;
                        assetList.appendChild(assetElement);
                    });
                } else {
                    const error = await response.json();
                    console.error('Failed to load assets:', error);
                }
            } catch (error) {
                console.error('Failed to load assets:', error);
            }
        }

        // Add logout function
        function logout() {
            // Clear all stored data
            localStorage.removeItem('userIdentifier');
            localStorage.removeItem('userId');
            localStorage.removeItem('accessToken');
            currentUsername = '';
            userAccount = '';
            currentEmail = '';
            
            // Reset UI
            document.getElementById('navConnectWallet').textContent = 'Connect Wallet';
            document.getElementById('navConnectWallet').classList.remove('hidden');
            document.getElementById('navLogout').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('userGuide').classList.add('hidden');
            document.getElementById('login').classList.remove('hidden');
            
            // Clear any displayed assets
            const assetList = document.getElementById('assetList');
            if (assetList) {
                assetList.innerHTML = '';
            }
            
            // Reset forms
            document.getElementById('uploadForm').reset();
            document.getElementById('accessRuleForm').reset();
            document.getElementById('messageForm').reset();
        }

        // Add profile loading function
        async function loadProfile() {
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    console.error('No user ID found');
                    return;
                }
                
                const response = await fetch(`/api/v1/users/${userId}/profile`);
                if (response.ok) {
                    const profile = await response.json();
                    console.log('Profile loaded:', profile);
                    const profileContent = document.getElementById('profileContent');
                    
                    profileContent.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <p class="mt-1">${profile.email}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Username</label>
                                <p class="mt-1">${profile.username}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Full Name</label>
                                <p class="mt-1">${profile.full_name || 'Not provided'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                                <p class="mt-1">${profile.phone_number || 'Not provided'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
                                <p class="mt-1">${profile.date_of_birth ? new Date(profile.date_of_birth).toLocaleDateString() : 'Not provided'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Address</label>
                                <p class="mt-1">${profile.address || 'Not provided'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Wallet Address</label>
                                <p class="mt-1">${profile.wallet_address ? profile.wallet_address : 'Not connected'}</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">Bio</label>
                                <p class="mt-1">${profile.bio || 'Not provided'}</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button onclick="editProfile()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                Edit Profile
                            </button>
                        </div>
                    `;

                    const connectWalletSection = document.getElementById('connectWalletSection');
                    if (connectWalletSection) {
                        if (!profile.wallet_address) {
                            connectWalletSection.innerHTML = `
                                <button id="dashboardConnectWallet" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 mt-2">
                                    Connect Wallet
                                </button>
                            `;
                            document.getElementById('dashboardConnectWallet').onclick = connectWallet;
                        } else {
                            connectWalletSection.innerHTML = `<span class="text-green-600 font-semibold">Wallet Connected</span>`;
                        }
                    }
                } else {
                    console.error('Failed to load profile');
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        // Add profile editing function
        async function editProfile() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                alert('Please log in first');
                return;
            }

            const profileContent = document.getElementById('profileContent');
            const response = await fetch(`/api/v1/users/${userId}/profile`);
            const profile = await response.json();

            profileContent.innerHTML = `
                <form id="profileForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" name="full_name" value="${profile.full_name || ''}" 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                            <input type="tel" name="phone_number" value="${profile.phone_number || ''}"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
                            <input type="date" name="date_of_birth" value="${profile.date_of_birth ? new Date(profile.date_of_birth).toISOString().split('T')[0] : ''}"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Address</label>
                            <input type="text" name="address" value="${profile.address || ''}"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Bio</label>
                            <textarea name="bio" rows="3"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">${profile.bio || ''}</textarea>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="loadProfile()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                            Save Changes
                        </button>
                    </div>
                </form>
            `;

            // Add form submit handler
            document.getElementById('profileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch(`/api/v1/users/${userId}/profile`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });

                    if (response.ok) {
                        loadProfile();
                    } else {
                        alert('Failed to update profile');
                    }
                } catch (error) {
                    console.error('Failed to update profile:', error);
                    alert('Failed to update profile');
                }
            });
        }
    </script>
</body>
</html> 